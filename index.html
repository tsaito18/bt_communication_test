<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Python BLE Client</title>
</head>
<body>
    <h2>Python BLEと通信 (Bumble版)</h2>
    <button id="btnConnect">接続する</button>
    <button id="btnRead">読み取る</button>
    <button id="btnWrite">書き込む</button>
    <div id="status">未接続</div>

    <script>
        const SERVICE_UUID = "a07498ca-ad5b-474e-940d-16f1fbe7e8cd";
        const CHARACTERISTIC_UUID = "51ff12bb-3ed8-46e5-b4f9-d64e2fec021b";
        let deviceCache = null;
        let characteristicCache = null;

        async function connect() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    // acceptAllDevices: true,
                    filters: [{ name: 'ほうじちゃ' }],
                    optionalServices: [SERVICE_UUID]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                characteristicCache = await service.getCharacteristic(CHARACTERISTIC_UUID);
                document.getElementById('status').innerText = "接続完了";
            } catch (e) {
                console.error(e);
                alert(e);
            }
        }

        async function readValue() {
            if (!characteristicCache) return;
            const value = await characteristicCache.readValue();
            const decoder = new TextDecoder('utf-8');
            alert("受信: " + decoder.decode(value));
        }

        async function writeValue() {
            if (!characteristicCache) return;
            const encoder = new TextEncoder('utf-8');
            await characteristicCache.writeValue(encoder.encode("Hello Python " + Date.now()));
            console.log("書き込み完了");
        }

        document.getElementById('btnConnect').onclick = connect;
        document.getElementById('btnRead').onclick = readValue;
        document.getElementById('btnWrite').onclick = writeValue;
    </script>
</body>
</html>