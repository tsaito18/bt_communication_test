<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bt_communication_test</title>
</head>

<body>
    <h2>bt_communication_test</h2>
    <button id="btnConnect">接続する</button>
    <button id="btnWrite">書き込む</button>
    <div id="status">未接続</div>
    <textarea id="log" cols="60" rows="10" readonly></textarea>

    <script>
        const SERVICE_UUID = "845d1d9a-b986-45b8-8b0e-21ee94307983"
        const TX_CHARACTERISTIC_UUID = "3ecd3272-0f80-4518-ad58-78aa9af3ec9d"
        const RX_CHARACTERISTIC_UUID = "47153006-9eef-45e5-afb7-038ea60ad893"
        let deviceCache = null;
        let txCharCache = null;
        let rxCharCache = null;

        async function connect() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'ほうじちゃ_' }],
                    optionalServices: [SERVICE_UUID]
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                txCharCache = await service.getCharacteristic(TX_CHARACTERISTIC_UUID);
                rxCharCache = await service.getCharacteristic(RX_CHARACTERISTIC_UUID);

                txCharCache.addEventListener('characteristicvaluechanged', (event) => {
                    const decoder = new TextDecoder('utf-8');
                    const message = decoder.decode(event.target.value);
                    const log = document.getElementById('log');
                    log.value += '[受信] ' + message + '\n';
                    log.scrollTop = log.scrollHeight;
                    console.log('受信:', message);
                });
                await txCharCache.startNotifications();

                document.getElementById('status').innerText = "接続完了";
            } catch (e) {
                console.error(e);
                alert(e);
            }
        }

        async function writeValue() {
            if (!rxCharCache) return;
            const encoder = new TextEncoder('utf-8');
            await rxCharCache.writeValueWithoutResponse(encoder.encode("Hello Python " + Date.now()));
            console.log("書き込み完了");
        }

        document.getElementById('btnConnect').onclick = connect;
        document.getElementById('btnWrite').onclick = writeValue;
    </script>
</body>

</html>